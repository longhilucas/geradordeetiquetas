<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Etiquetas A4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .label-preview-item {
            /* width & height are now set by JS */
            border: 1px dashed #cbd5e0; background-color: #f7fafc;
            margin: 2px; padding: 1mm; box-sizing: border-box; font-size: 7pt;
            overflow: hidden; display: flex; flex-direction: column; justify-content: center;
            align-items: flex-start; /* Keeps the start of the line at the left edge */
            position: relative; word-wrap: break-word;
        }
        .label-preview-item .line {
            width: 100%; overflow: hidden; text-overflow: ellipsis; line-height: 1.1;
            max-height: 100%; 
        }
        .label-controls {
            position: absolute; top: -1px; right: -1px; background-color: rgba(200, 200, 200, 0.8);
            padding: 1px; display: none; border-radius: 0 0 0 3px; z-index: 10;
        }
        .label-preview-item:hover .label-controls { display: flex; flex-direction: row; }
        .label-controls button { background: none; border: none; cursor: pointer; font-size: 8pt; padding: 2px 3px; color: #2d3748; }
        .label-controls button:hover { color: #2b6cb0; }
        .style-option-label {
            display: inline-flex; align-items: center; margin-right: 8px;
            font-size: 0.75rem; color: #4a5568; cursor: pointer;
        }
        .style-option-label input { margin-right: 3px; }
        .line-input-group {
             transition: all 0.3s ease-in-out;
        }
        
        /* Help Button Styles */
        #help-container:hover #help-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        @media print {
            body { margin: 0; padding: 0; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            #help-container, #controlsArea, .label-controls, title, #printSettingsAreaTitle, #printSettingsInputs { display: none !important; visibility: hidden !important; }
            #a4PreviewContainer, #a4PreviewContainer * { visibility: visible !important; }
            #a4PreviewContainer {
                position: absolute !important; left: 0 !important; top: 0 !important; width: 210mm !important;
                min-height: 297mm; margin: 0 !important; padding: 5mm !important; border: none !important;
                box-shadow: none !important; display: flex !important; flex-wrap: wrap !important;
                align-content: flex-start !important; gap: 0 !important; box-sizing: border-box !important;
                background-color: white !important; overflow: visible !important;
            }
            #a4PreviewContainer > .label-preview-item {
                /* width & height are set by JS */
                border: 0.1mm solid black !important;
                background-color: white !important; margin: 0 !important; padding: 0.5mm !important;
                box-sizing: border-box !important; overflow: hidden !important; display: flex !important;
                flex-direction: column !important; justify-content: center !important;
                align-items: flex-start !important; 
                page-break-inside: avoid !important; color: black !important;
            }
            #a4PreviewContainer > .label-preview-item > .line {
                width: 100% !important; overflow: hidden !important; text-overflow: ellipsis !important;
                word-break: break-all !important; margin: 0 !important; padding: 0 !important; color: black !important;
            }
        }
    </style>
    <style id="dynamicPrintStyles"></style>
</head>
<body class="bg-gray-200">

    <!-- Floating Help Button -->
    <div id="help-container" class="fixed bottom-6 left-6 z-50">
        <div id="help-button" class="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg cursor-pointer select-none">
            ?
        </div>
        <div id="help-tooltip" class="absolute bottom-0 left-20 w-80 p-4 bg-gray-800 text-white text-sm rounded-lg shadow-xl opacity-0 invisible transition-all duration-300 transform -translate-x-4">
            <h4 class="font-bold mb-2 text-base">Instru√ß√µes de Uso</h4>
            <ul class="list-disc list-inside space-y-1">
                <li>Use '<b>+ Adicionar Nova Linha</b>' para criar campos de texto.</li>
                <li>Defina o texto, estilo (<b>N, I, S</b>) e <b>alinhamento</b>.</li>
                <li>Clique em '<b>Adicionar Etiqueta</b>' para criar uma etiqueta.</li>
                <li>Ajuste a <b>Largura</b>, <b>Altura</b>, <b>Fonte</b> e <b>Espa√ß. Linhas</b> para a impress√£o.</li>
                <li>Edite (‚úèÔ∏è) ou exclua (üóëÔ∏è) etiquetas na √°rea de visualiza√ß√£o.</li>
            </ul>
            <p class="mt-3 border-t border-gray-600 pt-2 text-xs italic">
                <strong>Dica de Impress√£o:</strong> Para 4 linhas em uma etiqueta de 20x10mm, uma fonte de <b>6pt</b> √© ideal. Para mais linhas ou tamanhos diferentes, ajuste a fonte.
            </p>
        </div>
    </div>


    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div id="controlsArea" class="mb-6">
            <div class="bg-white p-6 rounded-lg shadow-xl mb-6">
                <h1 class="text-3xl font-bold mb-6 text-center text-gray-700">Gerador de Etiquetas</h1>
                
                <div id="lineInputsContainer" class="space-y-4 mb-4">
                    <!-- Line inputs will be dynamically inserted here -->
                </div>

                <div class="mt-4">
                     <button id="addNewLineBtn" class="w-full sm:w-auto bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-150 ease-in-out">
                        + Adicionar Nova Linha
                    </button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-2 mt-6 border-t pt-6">
                    <button id="addLabelBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out">
                        Adicionar Etiqueta
                    </button>
                    <button id="clearInputsBtn" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out">
                        Limpar Campos
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-xl">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 id="printSettingsAreaTitle" class="text-2xl font-semibold text-gray-700 mb-4 sm:mb-0">Configura√ß√µes de Impress√£o</h2>
                </div>
                <div id="printSettingsInputs" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 mb-6 border-t pt-6">
                     <div>
                        <label for="printLabelWidth" class="block text-sm font-medium text-gray-700">Largura Etiqueta (mm):</label>
                        <input type="number" id="printLabelWidth" value="20" step="1" min="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 h-10">
                    </div>
                    <div>
                        <label for="printLabelHeight" class="block text-sm font-medium text-gray-700">Altura Etiqueta (mm):</label>
                        <input type="number" id="printLabelHeight" value="10" step="1" min="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 h-10">
                    </div>
                    <div>
                        <label for="printFontSize" class="block text-sm font-medium text-gray-700">Fonte Impress√£o (pt):</label>
                        <input type="number" id="printFontSize" value="6" step="0.1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 h-10">
                    </div>
                    <div>
                        <label for="printLineHeight" class="block text-sm font-medium text-gray-700">Espa√ß. Linhas (x):</label>
                        <input type="number" id="printLineHeight" value="1.0" step="0.1" min="0.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 h-10">
                    </div>
                </div>
                 <button id="printBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out">
                    Imprimir Etiquetas
                </button>
            </div>
        </div>

        <div id="a4PreviewContainerWrapper" class="flex justify-center">
            <div id="a4PreviewContainer" class="bg-white shadow-2xl rounded-sm p-2 mx-auto overflow-y-auto" style="width: 210mm; min-height: 297mm; border: 1px solid #ccc; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 1mm; padding: 5mm;">
                 <p id="emptyMessage" class="text-center text-gray-500 italic p-10 w-full">Nenhuma etiqueta adicionada. Use o formul√°rio acima.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lineInputsContainer = document.getElementById('lineInputsContainer');
            const addNewLineBtn = document.getElementById('addNewLineBtn');
            const addLabelBtn = document.getElementById('addLabelBtn');
            const clearInputsBtn = document.getElementById('clearInputsBtn');
            const printBtn = document.getElementById('printBtn');
            const a4PreviewContainer = document.getElementById('a4PreviewContainer');
            const emptyMessage = document.getElementById('emptyMessage');
            
            const printLabelWidthInput = document.getElementById('printLabelWidth');
            const printLabelHeightInput = document.getElementById('printLabelHeight');
            const printFontSizeInput = document.getElementById('printFontSize');
            const printLineHeightInput = document.getElementById('printLineHeight');
            const dynamicPrintStylesTag = document.getElementById('dynamicPrintStyles');

            let labels = []; 
            let editingLabelId = null; 

            const escapeHtml = (unsafe) => (unsafe ?? '').toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");

            const createLineInputBlock = (lineData = { text: '', bold: false, italic: false, underline: false, align: 'left' }) => {
                const lineId = 'line-' + Date.now() + Math.random();
                const div = document.createElement('div');
                div.className = 'line-input-group border border-gray-200 p-3 rounded-md relative';
                div.innerHTML = `
                    <input type="text" value="${escapeHtml(lineData.text)}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 h-10" placeholder="Texto da linha...">
                    <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2 items-center">
                        <label class="style-option-label"><input type="checkbox" ${lineData.bold ? 'checked' : ''} class="bold-cb form-checkbox h-4 w-4 text-indigo-600 rounded"><span class="ml-1 font-semibold">N</span></label>
                        <label class="style-option-label"><input type="checkbox" ${lineData.italic ? 'checked' : ''} class="italic-cb form-checkbox h-4 w-4 text-indigo-600 rounded"><span class="ml-1 italic">I</span></label>
                        <label class="style-option-label"><input type="checkbox" ${lineData.underline ? 'checked' : ''} class="underline-cb form-checkbox h-4 w-4 text-indigo-600 rounded"><span class="ml-1 underline">S</span></label>
                    </div>
                    <div class="mt-2 border-t border-gray-100 pt-2 flex flex-wrap gap-x-4 gap-y-1 items-center text-sm">
                        <span class="font-medium text-gray-600 text-xs">Alinhamento:</span>
                        <label class="style-option-label"><input type="radio" name="${lineId}-align" value="left" ${lineData.align === 'left' ? 'checked' : ''}><span>Esquerda</span></label>
                        <label class="style-option-label"><input type="radio" name="${lineId}-align" value="center" ${lineData.align === 'center' ? 'checked' : ''}><span>Centro</span></label>
                        <label class="style-option-label"><input type="radio" name="${lineId}-align" value="right" ${lineData.align === 'right' ? 'checked' : ''}><span>Direita</span></label>
                    </div>
                    <button class="remove-line-btn absolute top-2 right-2 text-gray-400 hover:text-red-500" title="Remover linha">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                `;
                div.querySelector('.remove-line-btn').addEventListener('click', () => {
                    if (lineInputsContainer.childElementCount > 1) div.remove();
                });
                lineInputsContainer.appendChild(div);
            };

            const getInputs = () => {
                const lines = [];
                lineInputsContainer.querySelectorAll('.line-input-group').forEach(group => {
                    lines.push({
                        text: group.querySelector('input[type="text"]').value,
                        bold: group.querySelector('.bold-cb').checked,
                        italic: group.querySelector('.italic-cb').checked,
                        underline: group.querySelector('.underline-cb').checked,
                        align: group.querySelector('input[type="radio"]:checked')?.value || 'left',
                    });
                });
                return { lines };
            };

            const setInputs = (data) => {
                lineInputsContainer.innerHTML = '';
                if (data?.lines?.length > 0) {
                    data.lines.forEach(line => createLineInputBlock(line));
                } else {
                    createLineInputBlock();
                }
            };

            const clearInputs = () => {
                setInputs(null);
                lineInputsContainer.querySelector('input[type="text"]')?.focus();
            };
            
            const renderLabels = () => {
                const labelWidth = printLabelWidthInput.value;
                const labelHeight = printLabelHeightInput.value;

                a4PreviewContainer.innerHTML = ''; 
                if (labels.length === 0) {
                    a4PreviewContainer.appendChild(emptyMessage);
                    emptyMessage.style.display = 'block';
                } else {
                    emptyMessage.style.display = 'none';
                    labels.forEach(label => {
                        const labelDiv = document.createElement('div');
                        labelDiv.className = 'label-preview-item'; 
                        labelDiv.dataset.id = label.id;
                        labelDiv.style.width = `${labelWidth}mm`;
                        labelDiv.style.height = `${labelHeight}mm`;
                        
                        let labelHTML = label.lines.map(lineData => {
                            let style = '';
                            if (lineData.bold) style += 'font-weight: bold; ';
                            if (lineData.italic) style += 'font-style: italic; ';
                            if (lineData.underline) style += 'text-decoration: underline; ';
                            style += `text-align: ${lineData.align || 'left'};`;
                            return `<div class="line" style="${style}">${escapeHtml(lineData.text)}</div>`;
                        }).join('');
                        
                        labelHTML += `<div class="label-controls"><button class="edit-btn" title="Editar">‚úèÔ∏è</button><button class="delete-btn" title="Excluir">üóëÔ∏è</button></div>`;
                        labelDiv.innerHTML = labelHTML;
                        
                        labelDiv.querySelector('.edit-btn').addEventListener('click', () => startEditLabel(label.id));
                        labelDiv.querySelector('.delete-btn').addEventListener('click', () => deleteLabel(label.id));
                        
                        a4PreviewContainer.appendChild(labelDiv);
                    });
                }
            };

            [printLabelWidthInput, printLabelHeightInput].forEach(input => {
                input.addEventListener('input', renderLabels);
            });

            addNewLineBtn.addEventListener('click', () => createLineInputBlock());

            addLabelBtn.addEventListener('click', () => {
                const currentData = getInputs();
                if (editingLabelId !== null) {
                    const labelIndex = labels.findIndex(l => l.id === editingLabelId);
                    if (labelIndex > -1) labels[labelIndex] = { id: editingLabelId, ...currentData };
                    editingLabelId = null; 
                    addLabelBtn.textContent = 'Adicionar Etiqueta'; 
                    addLabelBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600'); 
                    addLabelBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); 
                } else {
                    labels.push({ id: Date.now(), ...currentData });
                }
                renderLabels(); 
            });

            clearInputsBtn.addEventListener('click', () => {
                clearInputs();
                if (editingLabelId !== null) { 
                    editingLabelId = null;
                    addLabelBtn.textContent = 'Adicionar Etiqueta';
                    addLabelBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    addLabelBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            });
            
            window.startEditLabel = (id) => {
                const label = labels.find(l => l.id === id);
                if (label) {
                    setInputs({ lines: label.lines });
                    editingLabelId = id; 
                    addLabelBtn.textContent = 'Atualizar Etiqueta'; 
                    addLabelBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    addLabelBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600'); 
                    lineInputsContainer.querySelector('input[type="text"]')?.focus();
                    document.getElementById('controlsArea').scrollIntoView({ behavior: 'smooth' }); 
                }
            };

            window.deleteLabel = (id) => {
                labels = labels.filter(l => l.id !== id); 
                if (editingLabelId === id) { 
                    clearInputs(); 
                    editingLabelId = null;
                    addLabelBtn.textContent = 'Adicionar Etiqueta';
                    addLabelBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    addLabelBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
                renderLabels(); 
            };

            printBtn.addEventListener('click', () => {
                const labelWidth = printLabelWidthInput.value;
                const labelHeight = printLabelHeightInput.value;
                const fontSize = printFontSizeInput.value;
                const lineHeight = printLineHeightInput.value;

                dynamicPrintStylesTag.innerHTML = `
                    @media print {
                        #a4PreviewContainer > .label-preview-item { 
                            width: ${labelWidth}mm !important;
                            height: ${labelHeight}mm !important;
                            font-size: ${fontSize}pt !important;
                        }
                        #a4PreviewContainer > .label-preview-item > .line { 
                            line-height: ${lineHeight} !important;
                        }
                    }`;
                window.print(); 
            });
            
            // Initial setup
            clearInputs();
            renderLabels();
        });
    </script>
</body>
</html>
